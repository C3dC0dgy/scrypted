#!/usr/bin/env node

const path = require('path');
const child_process = require('child_process');
const { PortablePython } = require('@bjia56/portable-python')
const { once } = require('events');
let python;

async function pipInstall(pkg) {
    const cp = child_process.spawn(python, ['-m', 'pip', 'install', pkg], { stdio: 'inherit' });
    const [exitCode] = await once(cp, 'exit');
    if (exitCode)
        throw new Error('non-zero exit code: ' + exitCode);
}

async function installScryptedServerRequirements() {
    const py = new PortablePython("3.9", path.join(path.dirname(__dirname), 'py'));
    await py.install();
    python = py.executablePath;

    await pipInstall('wheel');
    await pipInstall('debugpy');
    await pipInstall('psutil').catch(() => {});
    await pipInstall('prompt_toolkit');
    await pipInstall('ptpython');
}

installScryptedServerRequirements();
